<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Tienda | √ìrdenes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial;
  margin: 0;
  background: #f7f7f7;
  display: flex;
  min-height: 100vh;
}
.contenedor { flex: 1; padding: 20px; }
.productos {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
  gap: 20px;
}
.producto {
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  text-align: center;
}
.producto img { width: 100%; border-radius: 8px; }
button {
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
}
.carrito {
  width: 300px;
  background: #fff;
  border-left: 2px solid #ddd;
  padding: 20px;
}

#btnAdmin{
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #111;
  color: #fff;
  border: none;
  padding: 12px 16px;
  border-radius: 50px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
}

.producto img{
  width: 220px;
  height: 150px;
  object-fit: contain;   /* üëà CLAVE */
  background: #fff;      /* opcional */
  border-radius: 6px;
}


</style>
</head>

<body>
<button id="btnAdmin">üõ†Ô∏è Admin</button>

<div class="contenedor">
  <h1>üõçÔ∏è Cat√°logo</h1>
  <div class="productos" id="productos"></div>
</div>

<div class="carrito">
  <h2>üõí Carrito</h2>
  <ul id="lista-carrito"></ul>
  <p id="total">Total: $0.00</p>
  <button id="generar">Generar Orden</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, push }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBSDmBuzRSGTYycswO7_p_kHgfscH67rJQ",
  authDomain: "catalogo-12ef6.firebaseapp.com",
  databaseURL: "https://catalogo-12ef6-default-rtdb.firebaseio.com",
  projectId: "catalogo-12ef6",
  storageBucket: "catalogo-12ef6.appspot.com",
  messagingSenderId: "792387780357",
  appId: "1:792387780357:web:d77a3333ffbcefba15816c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== ELEMENTOS ===== */
const contProductos = document.getElementById("productos");
const listaCarrito = document.getElementById("lista-carrito");
const totalEl = document.getElementById("total");
const generarBtn = document.getElementById("generar");

let productos = [];
let carrito = [];

/* ===== LEER PRODUCTOS ===== */
onValue(ref(db,"productos"), snap=>{
  productos = [];
  contProductos.innerHTML = "";

  if(!snap.exists()){
    contProductos.innerHTML = "<p>No hay productos</p>";
    return;
  }

  snap.forEach(child=>{
    productos.push({
      codigo: child.key,
      ...child.val()
    });
  });

  renderProductos();
});

/* ===== UI ===== */
function renderProductos(){
  contProductos.innerHTML = "";

  productos.forEach(p => {

    let img = p.foto
      ? p.foto.replace(
          "/upload/",
          "/upload/w_200,h_150,c_fit,f_auto,q_auto/"
        )
      : "https://via.placeholder.com/200x150";

    contProductos.innerHTML += `
      <div class="producto">
        <img src="${img}">
        <h3>${p.nombre}</h3>
        <p>$${p.precio}</p>
        <button onclick="agregar('${p.codigo}')">Agregar</button>
      </div>
    `;
  });
}




window.agregar = codigo=>{
  const prod = productos.find(p=>p.codigo===codigo);
  const item = carrito.find(i=>i.codigo===codigo);

  if(item) item.cantidad++;
  else carrito.push({...prod, cantidad:1});

  renderCarrito();
};

function renderCarrito(){
  listaCarrito.innerHTML="";
  let total=0;

  carrito.forEach(i=>{
    total += i.precio*i.cantidad;
    listaCarrito.innerHTML += `
      <li>${i.nombre} x${i.cantidad} - $${(i.precio*i.cantidad).toFixed(2)}</li>
    `;
  });

  totalEl.textContent = `Total: $${total.toFixed(2)}`;
}

/* ===== ORDEN ===== */
generarBtn.onclick = async ()=>{
  if(!carrito.length) return alert("Carrito vac√≠o");

  const nombre = prompt("Nombre cliente:");
  const telefono = prompt("WhatsApp:");

  const orden = {
    cliente:{nombre,telefono},
    items:carrito,
    total: carrito.reduce((s,i)=>s+i.precio*i.cantidad,0),
    estado:"NUEVA",
    fecha:Date.now()
  };

  await push(ref(db,"ordenes"), orden);
  enviarWhatsApp(orden);

  carrito=[];
  renderCarrito();
  alert("‚úÖ Orden creada");
};

/* ===== WHATSAPP ===== */
function enviarWhatsApp(o){
  const tel = o.cliente.telefono.replace(/\D/g,'');
  const detalle = o.items.map(i=>`${i.nombre} x${i.cantidad}`).join("\n");

  const msg = `üßæ FACTURA
Cliente: ${o.cliente.nombre}

${detalle}

TOTAL: $${o.total}`;

  window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`);
}

document.getElementById("btnAdmin").onclick = () => {
  window.location.href = "admin.html";
};
</script>

</body>
</html>
